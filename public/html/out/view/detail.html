<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
	<title>小小师傅—维修预约</title>
	<script src="../js/viewport.js" type='text/javascript'></script>
	<!-- <link rel="stylesheet" href="../style/weui.min.css"/>
	<link rel="stylesheet" href="../style/common.css"/> -->
	<!-- <script src='../js/jquery-1.10.2.min.js' type='text/javascript' charset='utf-8'></script>
	<script src="../js/jquery.form.js"></script>
	<script src="../js/common.js"></script>
	<script src="../js/server.js"></script> -->
	<link rel="stylesheet" href="../style/combine.min.css"/>
	<script src="../js/combine.min.js"></script>
</head>
<body>
	<!-- <div class="header"></div> -->
	<div class="step3-content bd-footer">
		<div class="weui_cells weui_cells_access weui_cells_form step1">
	        <div class="weui_cell">
	            <div class="weui_cell_hd">
	            	<label class="weui_label">联系名称</label>
	            </div>
	            <div class="weui_cell_bd weui_cell_primary">
	                <input class="weui_input nick" placeholder="联系名称">
	            </div>
	        </div>
	        <div class="weui_cell">
	            <div class="weui_cell_hd">
	            	<label class="weui_label">联系电话</label>
	            </div>
	            <div class="weui_cell_bd weui_cell_primary">
	                <input class="weui_input mobile" type="number" pattern="[0-9]*" placeholder="联系电话">
	            </div>
	        </div>
	        <div class="weui_cell">
	            <div class="weui_cell_hd">
	            	<label for="" class="weui_label">预约时间</label>
	            </div>
	            <div class="weui_cell_bd weui_cell_primary">
	                <input class="weui_input bookDate" type="datetime-local" value="" placeholder="">
	            </div>
	        </div> 
	        <div class="weui_cell">
	            <div class="weui_cell_bd weui_cell_primary">
	                <p>所在地区</p>
	            </div>
	            <div class="weui_cell_ft ssq">选择地区</div>
	            <input class="district" type="hidden">
	        </div>
			<!-- <div class="weui_cell weui_cell_select weui_select_after">
	            <div class="weui_cell_hd">
	                <label for="" class="weui_label">街道</label>
	            </div>
	            <div class="weui_cell_bd weui_cell_primary">
	                <select class="weui_select" name="select2">
	                    <option value="1">长河街道</option>
	                    <option value="2">中兴街道</option>
	                    <option value="3">浦沿街道</option>
	                </select>
	            </div>
	        </div> -->
			<div class="weui_cell">
	            <div class="weui_cell_bd weui_cell_primary">
	                <textarea class="weui_textarea address" placeholder="请填写详细地址" rows="3"></textarea>
	            </div>
	        </div>
    	</div>
    	<div class="weui_cells  weui_cells_form step2" style="display:none;margin-top:0;">
			<div class="weui_cell">
	            <div class="weui_cell_bd weui_cell_primary">
	                <textarea class="weui_textarea remark" placeholder="请输入备注内容" rows="3"></textarea>
	            </div>
	        </div>
			<div class="weui_cell">
            <div class="weui_cell_bd weui_cell_primary">
                <div class="weui_uploader">
                    <div class="weui_uploader_bd">
                        <ul class="weui_uploader_files">
                            <!-- <li class="weui_uploader_file" style="background-image:url(http://shp.qpic.cn/weixinsrc_pic/pScBR7sbqjOBJomcuvVJ6iacVrbMJaoJZkFUIq4nzQZUIqzTKziam7ibg/)"></li>
                            <li class="weui_uploader_file" style="background-image:url(http://shp.qpic.cn/weixinsrc_pic/pScBR7sbqjOBJomcuvVJ6iacVrbMJaoJZkFUIq4nzQZUIqzTKziam7ibg/)"></li>
                            <li class="weui_uploader_file" style="background-image:url(http://shp.qpic.cn/weixinsrc_pic/pScBR7sbqjOBJomcuvVJ6iacVrbMJaoJZkFUIq4nzQZUIqzTKziam7ibg/)"></li>
                            <li class="weui_uploader_file weui_uploader_status" style="background-image:url(http://shp.qpic.cn/weixinsrc_pic/pScBR7sbqjOBJomcuvVJ6iacVrbMJaoJZkFUIq4nzQZUIqzTKziam7ibg/)">
                                <div class="weui_uploader_status_content">
                                    <i class="weui_icon_warn"></i>
                                </div>
                            </li>
                            <li class="weui_uploader_file weui_uploader_status" style="background-image:url(http://shp.qpic.cn/weixinsrc_pic/pScBR7sbqjOBJomcuvVJ6iacVrbMJaoJZkFUIq4nzQZUIqzTKziam7ibg/)">
                                <div class="weui_uploader_status_content">50%</div>
                            </li> -->
                        </ul>
                        <input class="pics" type="hidden">
                        <form id="formFile"  class="weui_uploader_input_wrp" name="formFile" method="post" action="/quiz/pic/upload" target="frameFile" enctype="multipart/form-data">
                            <input id="input-file" name="myfile" class="weui_uploader_input" type="file" accept="image/jpg,image/jpeg,image/png,image/gif" multiple="multiple">
                        </form>
                        <input class="pics" type="hidden" val="">
                    </div>
                </div>
            </div>
        </div>
    </div>
	</div>
	<div class="weui_actionsheet" id="selectPlace">
		<div class="bd">
			<div class="weui_search_bar weui_search_focusing" id="search_bar">
		        <form class="weui_search_outer">
		            <div class="weui_search_inner">
		                <i class="weui_icon_search"></i>
		                <input type="search" class="weui_search_input" id="search_input" placeholder="请输入地址关键字" required="">
		                <a href="javascript:" class="weui_icon_clear" id="search_clear"></a>
		            </div>
		        </form>
		        <a href="javascript:" class="weui_search_cancel" id="search_cancel">取消</a>
		    </div>
		</div>
		<div class="placeList">
			<!-- <div class="placeRow">
				<p class="placeRow-name">临江花园</p>
				<p class="placeRow-district">杭州市 滨江区</p> 
			</div> -->
		</div>
	</div>
	<div class="footer">
		<!-- <div class="icon-toTop"></div>
		<div class="icon-toHome"></div> -->
		<div class="ctrl-btn">
			<div class="ctrl-btn-pre">上一步</div>
			<div class="ctrl-btn-next">下一步</div>
			<div class="ctrl-btn-confirm" style="display:none;">立即预约</div>
		</div>
	</div>

	<script>
		var step = 1;
		var obj = {
			firstCatName: '',
			secondCatName: '',
			thirdCatName: '',
			expectPrice: '',
			nick: '',
			mobile: '',
			bookDate: '',
			district: '',
			address: '',
			remark: '',
			pics: []
		}
		$(document).ready(function(){
			init();
			Bind();
		})
		function init(){

		}
		function Bind(){
			var placeList = {}
			//地址弹窗 点击弹出
			$(document).on('click','.ssq',function(e){
		    	$('#selectPlace').addClass('weui_actionsheet_toggle');
		    })
		    //地址弹窗 关闭点击
		    $(document).on('click','#search_cancel',function(e){
		    	$('#selectPlace').removeClass('weui_actionsheet_toggle');
		    })
		    //地址弹窗 输入框清空
		    $(document).on('click','.weui_icon_clear',function(e){
		    	$('#search_input').val('');
		    })
		    //地址弹窗 输入框输入
		    $(document).on('input','#search_input',function(e){
		    	var _val = $('#search_input').val();
		    	var params = {
		    		keyword: _val,
		    		region: '佛山市'
		    	}
		    	WAjax('request_search_area',params,function(json){
					// debugger
					if(json.result == 100){
						var html =  '';
						for (var i = 0; i < json.data.result.length; i++) {
							placeList['p'+json.data.result[i].uid] = json.data.result[i];
							html += '<div class="placeRow" uid="'+json.data.result[i].uid+'">'+
										'<p class="placeRow-name">'+ json.data.result[i].name +'</p>'+
										'<p class="placeRow-district">'+ json.data.result[i].city+ '&nbsp;&nbsp;&nbsp;&nbsp;' + json.data.result[i].district +'</p> '+
									'</div>';
						}
						html += '</div>';
						$('.placeList').html(html);
					}
				})
		    })
		    //地址弹窗 列表点击
		    $(document).on('click','.placeRow',function(e){
		    	var uid = $(e.currentTarget).attr('uid');
		    	var place = placeList['p'+uid];
		    	console.log(place);
		    	$('.ssq').html(place.district+" "+place.name);
		    	$('.district').val(place.district+" "+place.name);
		    	$('#selectPlace').removeClass('weui_actionsheet_toggle');

		    })
		    //地址弹窗 列表点击
		    $(document).on('click','.delete_pic',function(e){
		    	var pic_id = $(e.currentTarget).attr('pic-id');
		    	obj.pics.splice(parseInt(pic_id));
		    	render_pic()
		    })
		    //图片选择上传
            $(document).on('change','#input-file',function(e){
            	console.log($(e.target).val());
	            if($(e.target).val() == ""){
	                return;
	            }
	            if(e.target.files.length>3){
	            	toast('最多选择3张');
	            	return
	            }
	            showLoading();
	            $('#formFile').ajaxSubmit({
	                url: SERVER_Path['upload_order_pics'],
	                dataType:"json", //数据类型
	                success:function(json){
	                    console.log(json);
	                    clearShow()
	                    if(json.result == 100){
	                    	if(json.data&&json.data.pics&&json.data.pics.length>0){
	                    		for (var i = 0; i < json.data.pics.length; i++) {
	                    			// html += '<li class="weui_uploader_file" style="background-image:url('+json.data.pics[i]+')"></li>';
	                    			if(obj.pics.length<3){
	                    				obj.pics.push(json.data.pics[i]);
	                    			} else {
	                    				toast('图片最多3张');
	                    			}
	                    		}
	                    	}
	                    	render_pic();
	                        $('#input-file').val('');
	                    }
	                }
	            });
            });
            //上一步
            $(document).on('click','.ctrl-btn-pre',function(e){
            	if(step == 1){
            		location.href = 'list3.html?cate-id=' + window.sessionStorage.getItem('secondCatId');
            	} else if(step == 2){
            		step = 1;
            		$('.ctrl-btn-next').show();
            		$('.ctrl-btn-confirm').hide();
            		$('.step1').show();
        			$('.step2').hide();
            	}
            });
            //下一步
            $(document).on('click','.ctrl-btn-next',function(e){
            	var nick = $('.nick').val();
            	var mobile = $('.mobile').val();
            	var bookDate = $('.bookDate').val();
            	var district = $('.district').val();
            	var address = $('.address').val();
        		if(nick){
        			obj.nick = nick;
        		} else {
        			toast('请输入联系名称');
        			return
        		}
        		if(mobile && validatemobile(mobile)){

        			obj.mobile = mobile;
        		} else {
        			toast('请输入正确的电话');
        			return
        		}
        		if(bookDate){
        			var bookDate_str = new Date(bookDate).getTime();
        			var nowDate_str = new Date().getTime();
        			if(nowDate_str > bookDate_str){
        				toast('请选择将来的时间');
        				return
        			}
        			obj.bookDate = bookDate.replace('T',' ')+':00';
        		} else {
        			toast('请输入预约时间');
        			return
        		}
        		if(district){
        			obj.district = district;
        		} else {
        			toast('请选择地区');
        			return
        		}
        		if(address){
        			obj.address = address;
        		} else {
        			toast('请输入详细地址');
        			return
        		}
        		step = 2;
        		$('.ctrl-btn-next').hide();
        		$('.ctrl-btn-confirm').show();
        		$('.step1').hide();
        		$('.step2').show();
            });
            //立即预约
            $(document).on('click','.ctrl-btn-confirm',function(e){
            	var remark = $('.remark').val();
            	// var pics = $('.pics').val();
            	if(remark){
            		obj.remark = remark;
            	}
            	if(obj.pics){
            		obj.pics = JSON.stringify(obj.pics);
            	}
            	// obj.open_id = window.sessionStorage.getItem('open_id');
            	obj.firstCatName = window.sessionStorage.getItem('firstCatName');
            	obj.secondCatName = window.sessionStorage.getItem('secondCatName');
            	obj.thirdCatName = window.sessionStorage.getItem('thirdCatName');
            	obj.expectPrice = window.sessionStorage.getItem('expectPrice');
            	// debugger
            	WAjax('add_new_order',obj,function(json){
					// debugger
					if(json.result == 100){
						location.href = 'result.html';
					} else {
						toast(json.message);
					}
				})
            	// location.href = 'result.html';
            });

		}
		function render_pic(){
			var html = '';
			if(obj.pics.length>0){
        		for (var i = 0; i < obj.pics.length; i++) {
        			html += '<li class="weui_uploader_file delete_pic" style="background-image:url('+obj.pics[i]+')" pic-id='+ i +'></li>';
        		}
        	}
        	$('.weui_uploader_files').html(html);
		}
	</script>
</body>
</html>